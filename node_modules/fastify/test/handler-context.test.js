'use strict'
const test = require('tap').test
const { kRouteContext } = require('../lib/symbols')
const fastify = require('../')

test('handlers receive correct `this` context', async (t) => {
  t.plan(4)

  // simulate plugin that uses fastify-plugin
  const plugin = function (instance, opts, done) {
    instance.decorate('bar', 'bar')
    done()
  }
  plugin[Symbol.for('skip-override')] = true

  const instance = fastify()
  instance.register(plugin)

  instance.get('/', function (req, reply) {
    t.ok(this.bar)
    t.equal(this.bar, 'bar')
    reply.send()
  })

  await instance.inject('/')

  t.ok(instance.bar)
  t.equal(instance.bar, 'bar')
})

test('handlers have access to the internal context', async (t) => {
  t.plan(5)

  const instance = fastify()
  instance.get('/', { config: { bar: 'bar' } }, function (req, reply) {
    t.ok(reply[kRouteContext])
    t.ok(reply[kRouteContext].config)
    t.type(reply[kRouteContext].config, Object)
    t.ok(reply[kRouteContext].config.bar)
    t.equal(reply[kRouteContext].config.bar, 'bar')
    reply.send()
  })

  await instance.inject('/')
})
