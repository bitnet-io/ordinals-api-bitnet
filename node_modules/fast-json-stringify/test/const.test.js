'use strict'

const test = require('tap').test
const validator = require('is-my-json-valid')
const build = require('..')

test('schema with const string', (t) => {
  t.plan(2)

  const schema = {
    type: 'object',
    properties: {
      bar: { const: 'bar' }
    }
  }

  const validate = validator(schema)
  const stringify = build(schema)
  const output = stringify({
    bar: 'bar'
  })

  t.equal(output, '{"bar":"bar"}')
  t.ok(validate(JSON.parse(output)), 'valid schema')
})

test('schema with const string and different input', (t) => {
  t.plan(2)

  const schema = {
    type: 'object',
    properties: {
      bar: { const: 'bar' }
    }
  }

  const validate = validator(schema)
  const stringify = build(schema)
  const output = stringify({
    bar: 'baz'
  })

  t.equal(output, '{"bar":"bar"}')
  t.ok(validate(JSON.parse(output)), 'valid schema')
})

test('schema with const string and different type input', (t) => {
  t.plan(2)

  const schema = {
    type: 'object',
    properties: {
      bar: { const: 'bar' }
    }
  }

  const validate = validator(schema)
  const stringify = build(schema)
  const output = stringify({
    bar: 1
  })

  t.equal(output, '{"bar":"bar"}')
  t.ok(validate(JSON.parse(output)), 'valid schema')
})

test('schema with const string and no input', (t) => {
  t.plan(2)

  const schema = {
    type: 'object',
    properties: {
      bar: { const: 'bar' }
    }
  }

  const validate = validator(schema)
  const stringify = build(schema)
  const output = stringify({})

  t.equal(output, '{}')
  t.ok(validate(JSON.parse(output)), 'valid schema')
})

test('schema with const number', (t) => {
  t.plan(2)

  const schema = {
    type: 'object',
    properties: {
      bar: { const: 1 }
    }
  }

  const validate = validator(schema)
  const stringify = build(schema)
  const output = stringify({
    bar: 1
  })

  t.equal(output, '{"bar":1}')
  t.ok(validate(JSON.parse(output)), 'valid schema')
})

test('schema with const number and different input', (t) => {
  t.plan(2)

  const schema = {
    type: 'object',
    properties: {
      bar: { const: 1 }
    }
  }

  const validate = validator(schema)
  const stringify = build(schema)
  const output = stringify({
    bar: 2
  })

  t.equal(output, '{"bar":1}')
  t.ok(validate(JSON.parse(output)), 'valid schema')
})

test('schema with const bool', (t) => {
  t.plan(2)

  const schema = {
    type: 'object',
    properties: {
      bar: { const: true }
    }
  }

  const validate = validator(schema)
  const stringify = build(schema)
  const output = stringify({
    bar: true
  })

  t.equal(output, '{"bar":true}')
  t.ok(validate(JSON.parse(output)), 'valid schema')
})

test('schema with const number', (t) => {
  t.plan(2)

  const schema = {
    type: 'object',
    properties: {
      bar: { const: 1 }
    }
  }

  const validate = validator(schema)
  const stringify = build(schema)
  const output = stringify({
    bar: 1
  })

  t.equal(output, '{"bar":1}')
  t.ok(validate(JSON.parse(output)), 'valid schema')
})

test('schema with const null', (t) => {
  t.plan(2)

  const schema = {
    type: 'object',
    properties: {
      bar: { const: null }
    }
  }

  const validate = validator(schema)
  const stringify = build(schema)
  const output = stringify({
    bar: null
  })

  t.equal(output, '{"bar":null}')
  t.ok(validate(JSON.parse(output)), 'valid schema')
})

test('schema with const array', (t) => {
  t.plan(2)

  const schema = {
    type: 'object',
    properties: {
      bar: { const: [1, 2, 3] }
    }
  }

  const validate = validator(schema)
  const stringify = build(schema)
  const output = stringify({
    bar: [1, 2, 3]
  })

  t.equal(output, '{"bar":[1,2,3]}')
  t.ok(validate(JSON.parse(output)), 'valid schema')
})

test('schema with const object', (t) => {
  t.plan(2)

  const schema = {
    type: 'object',
    properties: {
      bar: { const: { bar: 'baz' } }
    }
  }

  const validate = validator(schema)
  const stringify = build(schema)
  const output = stringify({
    bar: { bar: 'baz' }
  })

  t.equal(output, '{"bar":{"bar":"baz"}}')
  t.ok(validate(JSON.parse(output)), 'valid schema')
})

test('schema with const and null as type', (t) => {
  t.plan(4)

  const schema = {
    type: 'object',
    properties: {
      bar: { type: ['string', 'null'], const: 'baz' }
    }
  }

  const validate = validator(schema)
  const stringify = build(schema)
  const output = stringify({
    bar: null
  })

  t.equal(output, '{"bar":null}')
  t.ok(validate(JSON.parse(output)), 'valid schema')

  const output2 = stringify({ bar: 'baz' })
  t.equal(output2, '{"bar":"baz"}')
  t.ok(validate(JSON.parse(output2)), 'valid schema')
})

test('schema with const as nullable', (t) => {
  t.plan(4)

  const schema = {
    type: 'object',
    properties: {
      bar: { nullable: true, const: 'baz' }
    }
  }

  const validate = validator(schema)
  const stringify = build(schema)
  const output = stringify({
    bar: null
  })

  t.equal(output, '{"bar":null}')
  t.ok(validate(JSON.parse(output)), 'valid schema')

  const output2 = stringify({
    bar: 'baz'
  })
  t.equal(output2, '{"bar":"baz"}')
  t.ok(validate(JSON.parse(output2)), 'valid schema')
})

test('schema with const and invalid object', (t) => {
  t.plan(2)

  const schema = {
    type: 'object',
    properties: {
      bar: { const: { bar: 'bar' } }
    },
    required: ['bar']
  }

  const validate = validator(schema)
  const stringify = build(schema)
  const result = stringify({
    bar: { bar: 'baz' }
  })

  t.equal(result, '{"bar":{"bar":"bar"}}')
  t.ok(validate(JSON.parse(result)), 'valid schema')
})
